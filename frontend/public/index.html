<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Expense Tracker</title>
    <meta name="description" content="AI-powered expense tracking with smart insights">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #1a1a1b;
            --bg-tertiary: #2a2a2b;
            --bg-glass: rgba(26, 26, 27, 0.8);
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-muted: #8a8a8a;
            --accent-blue: #4a9eff;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-orange: #f59e0b;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 12px 40px rgba(0, 0, 0, 0.4);
            --gradient-primary: linear-gradient(135deg, #4a9eff 0%, #8b5cf6 100%);
            --gradient-card: linear-gradient(135deg, rgba(74, 158, 255, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 400px;
            min-height: 100vh;
            margin: 0 auto;
            background: var(--bg-primary);
            position: relative;
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
        }

        .main-content {
            padding: 20px;
            padding-bottom: 120px;
        }

        .greeting-section {
            margin-bottom: 35px;
            padding: 20px;
            background: var(--gradient-card);
            border-radius: 20px;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .greeting-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .greeting-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .greeting-emoji {
            font-size: 24px;
        }

        .greeting-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .greeting-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .settings-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .balance-card {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }

        .balance-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .balance-icon {
            color: var(--accent-blue);
            font-size: 20px;
        }

        .balance-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .balance-amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .balance-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 35px;
        }

        .action-btn {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--text-primary);
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .action-btn i {
            font-size: 20px;
            color: var(--accent-blue);
        }

        .action-btn span {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .action-btn.primary {
            background: var(--gradient-primary);
            color: white;
        }

        .action-btn.primary i,
        .action-btn.primary span {
            color: white;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--accent-blue);
        }

        .expense-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .expense-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .expense-item:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
        }

        .expense-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--accent-blue);
            border: 1px solid var(--border);
        }

        .expense-details {
            flex: 1;
        }

        .expense-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .expense-meta {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            gap: 15px;
        }

        .expense-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .expense-amount.negative {
            color: var(--accent-red);
        }

        .expense-amount.positive {
            color: var(--accent-green);
        }

        .delete-btn {
            background: var(--accent-red);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #c53030;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .stat-icon.income { color: var(--accent-green); }
        .stat-icon.expense { color: var(--accent-red); }
        .stat-icon.savings { color: var(--accent-blue); }
        .stat-icon.budget { color: var(--accent-purple); }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 380px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 12px;
            display: flex;
            justify-content: space-around;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow);
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 12px;
            border-radius: 15px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 60px;
        }

        .nav-btn.active {
            background: var(--gradient-primary);
            color: white;
        }

        .nav-btn i {
            font-size: 18px;
        }

        .nav-btn span {
            font-size: 10px;
            font-weight: 500;
        }

        .tab-page {
            display: none;
        }

        .tab-page.active {
            display: block;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-hover);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.2);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-muted);
        }

        .form-group input[type="date"] {
            color: var(--text-primary);
        }

        .form-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .empty-subtext {
            font-size: 14px;
            color: var(--text-muted);
        }

        .budget-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .budget-progress {
            margin-bottom: 16px;
        }

        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .budget-info h4 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        .budget-info p {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .budget-amount {
            text-align: right;
        }

        .budget-spent {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .budget-total {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--accent-orange), #ff8c42);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #ff4757, #ff6b7a);
        }

        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .calendar-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-nav {
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .calendar-date {
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 45px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden; /* Prevent text overflow */
        }

        .calendar-date:hover {
            background: var(--bg-tertiary);
        }

        .calendar-date.active {
            background: var(--gradient-primary);
            color: white;
        }

        .calendar-date.active .calendar-expenses {
            color: white;
        }

        .calendar-date.has-transactions {
            border: 2px solid var(--accent-blue);
        }

        .calendar-expenses {
          font-size: 10px;
          margin-top: 3px; /* Reduced margin to fit within height */
          line-height: 1.2;
          font-weight: 600;
          max-width: 100%; /* Prevent text from exceeding cell */
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .calendar-expenses.income {
            color: var(--accent-green);
        }

        .calendar-expenses.expense {
            color: var(--accent-red);
        }

        /* AI Components Styles */
        .ai-loading {
            text-align: center;
            padding: 40px 20px;
        }

        .loading-spinner {
            font-size: 32px;
            color: var(--accent-blue);
            margin-bottom: 15px;
        }

        .ai-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .ai-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .ai-section-header h4 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: var(--accent-blue);
            color: var(--text-primary);
        }

        /* Health Score Card */
        .health-score-card {
            background: var(--gradient-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .score-info h5 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .score-info p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .health-factors {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .health-factor {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Insights Container */
        .insights-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .insight-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .insight-card h5 {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 8px;
        }

        .insight-card p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .empty-insights {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-muted);
        }

        .empty-insights i {
            font-size: 24px;
            margin-bottom: 10px;
        }

        /* Prediction Card */
        .prediction-card {
            background: var(--gradient-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .prediction-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .prediction-header i {
            color: var(--accent-purple);
            font-size: 18px;
        }

        .prediction-header h5 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .prediction-content {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Savings Advice */
        .savings-advice-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .advice-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .advice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .advice-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-green);
        }

        .advice-priority {
            background: var(--accent-orange);
            color: var(--text-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .advice-priority.high {
            background: var(--accent-red);
        }

        .advice-priority.medium {
            background: var(--accent-orange);
        }

        .advice-priority.low {
            background: var(--accent-green);
        }

        .advice-message {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .advice-savings {
            font-size: 12px;
            color: var(--accent-green);
            font-weight: 600;
        }

        .empty-advice {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-muted);
        }

        .empty-advice i {
            font-size: 24px;
            margin-bottom: 10px;
        }

        /* Categorization Demo */
        .categorization-demo {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
        }

        .demo-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .demo-input input {
            flex: 1;
            min-width: 120px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .demo-input input::placeholder {
            color: var(--text-muted);
        }

        .categorization-result {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .categorization-result.success {
            border-color: var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .categorization-result p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0;
        }

        .categorization-result .suggested-category {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-green);
            margin-top: 5px;
        }

        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
                border-left: none;
                border-right: none;
            }

            .main-content {
                padding: 15px;
                padding-bottom: 100px;
            }

            .balance-amount {
                font-size: 28px;
            }

            .bottom-nav {
                width: 95%;
                bottom: 15px;
            }

            .calendar-date {
                padding: 8px;
                min-height: 45px;
            }

            .calendar-expenses {
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <main class="main-content">
            <!-- Home Tab -->
            <div id="tab-home" class="tab-page active">
                <!-- Greeting Section -->
                <div class="greeting-section">
                    <div class="greeting-header">
                        <div class="greeting-text">
                            <span class="greeting-emoji">üëã</span>
                            <div>
                                <div class="greeting-title" id="greeting-title">Good morning!</div>
                                <div class="greeting-subtitle">Here's your spending</div>
                            </div>
                        </div>
                        <button class="settings-btn" onclick="openModal('settings-modal')">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>

                <!-- Balance Card -->
                <div class="balance-card">
                    <div class="balance-header">
                        <i class="fas fa-wallet balance-icon"></i>
                        <span class="balance-label">Current Balance</span>
                    </div>
                    <div class="balance-amount" id="balance-amount">‚Çπ0.00</div>
                    <div class="balance-subtitle">**** 1910</div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="action-btn" onclick="openModal('income-modal')">
                        <i class="fas fa-plus"></i>
                        <span>Add Income</span>
                    </button>
                    <button class="action-btn primary" onclick="openModal('expense-modal')">
                        <i class="fas fa-minus"></i>
                        <span>Add Expense</span>
                    </button>
                    <button class="action-btn" onclick="switchTab('history')">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Transfer</span>
                    </button>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon income">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div class="stat-value" id="total-income">‚Çπ0.00</div>
                        <div class="stat-label">Income</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon expense">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div class="stat-value" id="total-expense">‚Çπ0.00</div>
                        <div class="stat-label">Expenses</div>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-history"></i>
                        Recent Transactions
                    </h3>
                </div>
                <div class="expense-list" id="recent-expenses">
                    <!-- Transactions will be populated by JS -->
                </div>

                <!-- Expense Visualization -->
                <div class="chart-container">
                    <canvas id="expense-chart"></canvas>
                </div>
            </div>

            <!-- AI Tab -->
            <div id="tab-ai" class="tab-page">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-robot"></i>
                        AI-Powered Intelligence
                    </h3>
                </div>
                
                <!-- AI Loading State -->
                <div id="ai-loading" class="ai-loading" style="display: none;">
                    <div class="loading-spinner">
                        <i class="fas fa-cog fa-spin"></i>
                    </div>
                    <p>Analyzing your financial data...</p>
                </div>

                <!-- AI Content -->
                <div id="ai-content">
                    <!-- Financial Health Score -->
                    <div class="ai-section">
                        <div class="ai-section-header">
                            <h4><i class="fas fa-heartbeat"></i> Financial Health Score</h4>
                            <button class="refresh-btn" onclick="refreshAI()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div id="health-score-card" class="health-score-card">
                            <div class="score-display">
                                <div class="score-circle">
                                    <span id="health-score">--</span>
                                </div>
                                <div class="score-info">
                                    <h5 id="health-grade">--</h5>
                                    <p id="health-message">Click refresh to analyze</p>
                                </div>
                            </div>
                            <div id="health-factors" class="health-factors"></div>
                        </div>
                    </div>

                    <!-- Smart Insights -->
                    <div class="ai-section">
                        <div class="ai-section-header">
                            <h4><i class="fas fa-lightbulb"></i> Smart Insights</h4>
                        </div>
                        <div id="insights-container" class="insights-container">
                            <div class="empty-insights">
                                <i class="fas fa-chart-line"></i>
                                <p>No insights available yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Predictive Analytics -->
                    <div class="ai-section">
                        <div class="ai-section-header">
                            <h4><i class="fas fa-chart-line"></i> Predictive Analytics</h4>
                        </div>
                        <div id="prediction-card" class="prediction-card">
                            <div class="prediction-header">
                                <i class="fas fa-crystal-ball"></i>
                                <h5>Next Month Prediction</h5>
                            </div>
                            <div id="prediction-content" class="prediction-content">
                                <p>Click refresh to get predictions</p>
                            </div>
                        </div>
                    </div>

                    <!-- Savings Advice -->
                    <div class="ai-section">
                        <div class="ai-section-header">
                            <h4><i class="fas fa-piggy-bank"></i> Savings Advice</h4>
                        </div>
                        <div id="savings-advice-container" class="savings-advice-container">
                            <div class="empty-advice">
                                <i class="fas fa-coins"></i>
                                <p>No advice available yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Smart Categorization -->
                    <div class="ai-section">
                        <div class="ai-section-header">
                            <h4><i class="fas fa-tags"></i> Smart Categorization</h4>
                        </div>
                        <div class="categorization-demo">
                            <div class="demo-input">
                                <input type="text" id="expense-name-input" placeholder="Enter expense name (e.g., Coffee at Starbucks)">
                                <input type="number" id="expense-amount-input" placeholder="Amount" step="0.01">
                                <button onclick="testCategorization()" class="btn btn-primary">
                                    <i class="fas fa-magic"></i> Categorize
                                </button>
                            </div>
                            <div id="categorization-result" class="categorization-result">
                                <p>Try entering an expense to see AI categorization</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Tab -->
            <div id="tab-budget" class="tab-page">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-chart-pie"></i>
                        Budget Overview
                    </h3>
                </div>
                <div class="budget-section">
                    <div id="budget-list">
                        <!-- Budgets will be populated by JS -->
                    </div>
                    <button class="btn btn-primary" onclick="openModal('budget-modal')">
                        <i class="fas fa-plus"></i>
                        Add Budget
                    </button>
                </div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="tab-page">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-history"></i>
                        Transaction History
                    </h3>
                </div>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        <span id="calendar-month-year"></span>
                        <button class="calendar-nav" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid" id="calendar-days">
                        <!-- Calendar days will be populated by JS -->
                    </div>
                </div>
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-list"></i>
                        Transactions
                    </h3>
                </div>
                <div class="expense-list" id="all-expenses">
                    <!-- Transactions will be populated by JS -->
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-btn active" onclick="switchTab('home')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-btn" onclick="switchTab('ai')">
                <i class="fas fa-robot"></i>
                <span>AI</span>
            </button>
            <button class="nav-btn" onclick="switchTab('budget')">
                <i class="fas fa-chart-pie"></i>
                <span>Budget</span>
            </button>
            <button class="nav-btn" onclick="switchTab('history')">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
        </nav>
    </div>

    <!-- Add Expense Modal -->
    <div id="expense-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Expense</h2>
                <button class="close-btn" onclick="closeModal('expense-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="expense-form">
                    <div class="form-group">
                        <label for="expense-name">Expense Name</label>
                        <input type="text" id="expense-name" placeholder="e.g., Lunch at Cafe" required>
                    </div>
                    <div class="form-group">
                        <label for="expense-amount">Amount (‚Çπ)</label>
                        <input type="number" id="expense-amount" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="expense-category">Category</label>
                        <select id="expense-category" required>
                            <option value="">Select Category</option>
                            <option value="food">Food & Dining</option>
                            <option value="transportation">Transportation</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="bills">Bills & Utilities</option>
                            <option value="shopping">Shopping</option>
                            <option value="health">Health & Fitness</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expense-date">Date</label>
                        <input type="date" id="expense-date" required>
                    </div>
                    <div class="form-group">
                        <label for="expense-description">Description (Optional)</label>
                        <textarea id="expense-description" rows="3" placeholder="Add a note..."></textarea>
                    </div>
                    <div class="form-buttons">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('expense-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Add Expense
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Income Modal -->
    <div id="income-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Income</h2>
                <button class="close-btn" onclick="closeModal('income-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="income-form">
                    <div class="form-group">
                        <label for="income-name">Income Source</label>
                        <input type="text" id="income-name" placeholder="e.g., Salary, Freelance" required>
                    </div>
                    <div class="form-group">
                        <label for="income-amount">Amount (‚Çπ)</label>
                        <input type="number" id="income-amount" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="income-category">Category</label>
                        <select id="income-category" required>
                            <option value="">Select Category</option>
                            <option value="salary">Salary</option>
                            <option value="freelance">Freelance</option>
                            <option value="investment">Investment</option>
                            <option value="gift">Gift</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="income-date">Date</label>
                        <input type="date" id="income-date" required>
                    </div>
                    <div class="form-buttons">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('income-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Add Income
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="close-btn" onclick="closeModal('settings-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="user-name">Your Name</label>
                    <input type="text" id="user-name" placeholder="Enter your name">
                    <button class="btn btn-primary" style="margin-top: 12px;" onclick="saveUserName()">Save Name</button>
                </div>
                <div class="form-group">
                    <label>Data Management</label>
                    <div class="form-buttons">
                        <button class="btn btn-primary" onclick="exportData()">Export Data</button>
                        <input type="file" id="import-data" accept=".json" style="display: none;" onchange="importData(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('import-data').click()">Import Data</button>
                    </div>
                </div>
                <div class="form-group">
                    <button class="btn btn-danger" onclick="resetData()">Reset All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Budget Modal -->
    <div id="budget-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Budget</h2>
                <button class="close-btn" onclick="closeModal('budget-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="budget-form">
                    <div class="form-group">
                        <label for="budget-category">Category</label>
                        <select id="budget-category" required>
                            <option value="">Select Category</option>
                            <option value="food">Food & Dining</option>
                            <option value="transportation">Transportation</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="bills">Bills & Utilities</option>
                            <option value="shopping">Shopping</option>
                            <option value="health">Health & Fitness</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="budget-amount">Budget Amount (‚Çπ)</label>
                        <input type="number" id="budget-amount" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-buttons">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('budget-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Add Budget
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
// Global variables
let expenses = [];
let budgets = [];
let chart = null;
const API_BASE_URL = '/api';

// Categories with icons and specific classes for coloring, aligned with server.py
const categories = {
    'Food': { icon: 'üçΩÔ∏è', class: 'category-food' },
    'Transportation': { icon: 'üöó', class: 'category-transportation' },
    'Bills': { icon: 'üìã', class: 'category-bills' },
    'Entertainment': { icon: 'üé¨', class: 'category-entertainment' },
    'Housing': { icon: 'üè†', class: 'category-housing' },
    'Groceries': { icon: 'üõí', class: 'category-groceries' },
    'Health': { icon: 'üíä', class: 'category-health' },
    'Education': { icon: 'üìö', class: 'category-education' },
    'Personal Care': { icon: 'üß¥', class: 'category-personal-care' },
    'Savings': { icon: 'üí∞', class: 'category-savings' },
    'Travel': { icon: '‚úàÔ∏è', class: 'category-travel' },
    'Other': { icon: 'üì¶', class: 'category-other' }
};

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    initializeEventListeners();
    populateMonthSelector();
    populateBudgetCategories();
    populateExpenseCategories();
    updateAll();
    setCurrentDate();
});

// Load data from localStorage
function loadData() {
    const savedExpenses = localStorage.getItem('expenses');
    const savedBudgets = localStorage.getItem('budgets');

    if (savedExpenses) {
        expenses = JSON.parse(savedExpenses);
    }

    if (savedBudgets) {
        budgets = JSON.parse(savedBudgets);
    }
}

// Save data to localStorage
function saveExpenses() {
    localStorage.setItem('expenses', JSON.stringify(expenses));
}

function saveBudgets() {
    localStorage.setItem('budgets', JSON.stringify(budgets));
}

// Initialize event listeners
function initializeEventListeners() {
    // Add Expense Modal
    document.getElementById('add-expense-btn').addEventListener('click', showExpenseModal);
    document.getElementById('close-modal').addEventListener('click', hideExpenseModal);
    document.getElementById('cancel-expense').addEventListener('click', hideExpenseModal);
    document.getElementById('expense-form').addEventListener('submit', addExpense);

    // AI Category Suggestion
    document.getElementById('suggest-category').addEventListener('click', suggestCategory);

    // Budget Management
    document.getElementById('add-budget-btn').addEventListener('click', showBudgetForm);
    document.getElementById('cancel-budget').addEventListener('click', hideBudgetForm);
    document.getElementById('save-budget').addEventListener('click', addBudget);

    // Data Management
    document.getElementById('export-btn').addEventListener('click', exportData);
    document.getElementById('import-file').addEventListener('change', importData);

    // AI Features
    document.getElementById('predict-btn').addEventListener('click', predictExpenses);
    document.getElementById('refresh-insights').addEventListener('click', refreshInsights);

    // Month Selector
    document.getElementById('month-selector').addEventListener('change', updateAll);

    // Close modal on backdrop click
    document.getElementById('expense-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideExpenseModal();
        }
    });
}

// Set current date in form
function setCurrentDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('expense-date').value = today;
}

// Toast notifications
function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    toastContainer.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'none';
        requestAnimationFrame(() => {
            toast.style.animation = '';
        });
    }, 50);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Show/Hide Loading
function showLoading() {
    document.getElementById('loading').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loading').classList.add('hidden');
}

// --- Modal Functions ---
function showExpenseModal() {
    document.getElementById('expense-modal').classList.add('active');
    document.getElementById('expense-modal').classList.remove('hidden');
    document.getElementById('expense-form').reset();
    setCurrentDate();
    document.getElementById('expense-category').value = '';
}

function hideExpenseModal() {
    document.getElementById('expense-modal').classList.remove('active');
    setTimeout(() => {
        document.getElementById('expense-modal').classList.add('hidden');
    }, 300);
}

// Populate expense categories in the form
function populateExpenseCategories() {
    const selector = document.getElementById('expense-category');
    const categoryOptions = Object.entries(categories).map(([category, { icon }]) => {
        return `<option value="${category}">${category}</option>`;
    }).join('');
    selector.innerHTML = `<option value="">Select category</option>${categoryOptions}`;
}

// Add Expense
async function addExpense(e) {
    e.preventDefault();

    const nameInput = document.getElementById('expense-name');
    const amountInput = document.getElementById('expense-amount');
    const dateInput = document.getElementById('expense-date');
    const categoryInput = document.getElementById('expense-category');
    const descriptionInput = document.getElementById('expense-description');

    const name = nameInput.value.trim();
    const amount = parseFloat(amountInput.value);
    const date = dateInput.value;
    const category = categoryInput.value;
    const description = descriptionInput.value.trim();

    if (!name || isNaN(amount) || amount <= 0 || !date || !category) {
        showToast('Please fill in all required fields with valid data', 'error');
        return;
    }

    const expense = {
        id: Date.now().toString(),
        name,
        amount,
        date,
        category,
        description
    };

    expenses.unshift(expense);
    saveExpenses();
    hideExpenseModal();
    updateAll();
    showToast('Expense added successfully!');
}

// Delete Expense
function deleteExpense(id) {
    if (confirm('Are you sure you want to delete this expense?')) {
        expenses = expenses.filter(expense => expense.id !== id);
        saveExpenses();
        updateAll();
        showToast('Expense deleted successfully!');
    }
}

// AI Category Suggestion
async function suggestCategory() {
    const nameInput = document.getElementById('expense-name');
    const amountInput = document.getElementById('expense-amount');
    const categoryInput = document.getElementById('expense-category');

    const name = nameInput.value.trim();
    const amount = amountInput.value;

    if (!name) {
        showToast('Please enter expense name first', 'error');
        return;
    }
    if (!amount || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
        showToast('Please enter a valid amount', 'error');
        return;
    }

    try {
        showLoading();
        const response = await fetch(`${API_BASE_URL}/expenses/categorize?expense_name=${encodeURIComponent(name)}&amount=${amount}`);
        const data = await response.json();

        if (data.suggested_category && categories[data.suggested_category]) {
            categoryInput.value = data.suggested_category;
            showToast(`AI suggested category: ${data.suggested_category}`);
        } else {
            if (data.suggested_category && confirm(`AI suggested "${data.suggested_category}". Add as 'Other'?`)) {
                categoryInput.value = 'Other';
            } else {
                categoryInput.value = '';
            }
            showToast(`AI suggestion processed.`);
        }
    } catch (error) {
        console.error('Error suggesting category:', error);
        showToast('Failed to get category suggestion', 'error');
    } finally {
        hideLoading();
    }
}

// --- Budget Functions ---
function showBudgetForm() {
    document.getElementById('budget-form').classList.remove('hidden');
    document.getElementById('budget-category').value = '';
    document.getElementById('budget-amount').value = '';
    document.getElementById('budget-period').value = 'monthly';
    populateBudgetCategories();
}

function hideBudgetForm() {
    document.getElementById('budget-form').classList.add('hidden');
}

function addBudget() {
    const category = document.getElementById('budget-category').value;
    const amountInput = document.getElementById('budget-amount');
    const amount = parseFloat(amountInput.value);
    const period = document.getElementById('budget-period').value;

    if (!category) {
        showToast('Please select a category', 'error');
        return;
    }
    if (isNaN(amount) || amount <= 0) {
        showToast('Please enter a valid budget amount', 'error');
        return;
    }

    const existingBudgetIndex = budgets.findIndex(b => b.category === category);
    if (existingBudgetIndex !== -1) {
        budgets[existingBudgetIndex] = { id: budgets[existingBudgetIndex].id, category, amount, period };
        showToast(`Budget for ${category} updated successfully!`);
    } else {
        const budget = {
            id: Date.now().toString(),
            category,
            amount,
            period
        };
        budgets.push(budget);
        showToast(`Budget for ${category} added successfully!`);
    }

    saveBudgets();
    hideBudgetForm();
    populateBudgetCategories();
    updateAll();
}

function deleteBudget(id) {
    if (confirm('Are you sure you want to remove this budget?')) {
        budgets = budgets.filter(b => b.id !== id);
        saveBudgets();
        populateBudgetCategories();
        updateAll();
        showToast('Budget removed successfully!');
    }
}

// --- AI Functions ---
async function predictExpenses() {
    if (expenses.length === 0) {
        showToast('Add some expenses to get predictions', 'error');
        return;
    }

    try {
        showLoading();
        const response = await fetch(`${API_BASE_URL}/expenses/predict`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ expenses })
        });

        const prediction = await response.json();
        const predictionResultDiv = document.getElementById('prediction-result');
        let categoryBreakdownHtml = '';
        if (prediction.data && prediction.data.category_breakdown) {
            categoryBreakdownHtml = `<div class="ai-breakdown">`;
            Object.entries(prediction.data.category_breakdown)
                .sort(([,a], [,b]) => b - a)
                .forEach(([cat, amt]) => {
                    const catInfo = categories[cat] || categories['Other'];
                    const icon = `<span class="category-icon">${catInfo.icon}</span>`;
                    const categoryClass = catInfo.class;
                    categoryBreakdownHtml += `
                        <div class="ai-category-item">
                            <span class="ai-category-name"><span class="${categoryClass}">${icon}</span>${cat}</span>
                            <span class="ai-category-amount">‚Çπ${amt.toFixed(2)}</span>
                        </div>
                    `;
                });
            categoryBreakdownHtml += `</div>`;
        }

        predictionResultDiv.innerHTML = `
            <div class="budget-item">
                <div class="budget-header">
                    <div class="budget-info"><h3><i class="fas fa-chart-line"></i> Next Month Forecast</h3></div>
                    <div class="budget-stats">
                        <div class="budget-amount">${prediction.confidence ? (prediction.confidence * 100).toFixed(0) + '%' : 'N/A'}</div>
                        <small>Confidence</small>
                    </div>
                </div>
                <p>${prediction.message}</p>
                ${categoryBreakdownHtml}
                ${prediction.data.recommendations ? `
                    <div class="insight-data">
                        <h4>Recommendations:</h4>
                        ${prediction.data.recommendations.map(rec => `<span class="data-item">${rec}</span>`).join('')}
                    </div>
                ` : ''}
            </div>
        `;
        predictionResultDiv.classList.remove('hidden');
        showToast('Forecast generated successfully!');
    } catch (error) {
        console.error('Error predicting expenses:', error);
        showToast('Failed to generate forecast', 'error');
    } finally {
        hideLoading();
    }
}

async function refreshInsights() {
    if (expenses.length === 0) {
        showToast('Add some expenses to get insights', 'error');
        return;
    }

    try {
        showLoading();
        // Fetch AI insights
        const insightsResponse = await fetch(`${API_BASE_URL}/expenses/insights`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ expenses })
        });
        const insights = await insightsResponse.json();

        // Fetch comprehensive analysis
        const analysisResponse = await fetch(`${API_BASE_URL}/analysis/comprehensive`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ expenses, budgets })
        });
        const analysis = await analysisResponse.json();

        const insightsContainer = document.getElementById('ai-insights');
        let insightsHtml = '';

        // Display AI insights
        if (insights.length > 0) {
            insightsHtml += insights.map(insight => {
                const insightType = insight.type.charAt(0).toUpperCase() + insight.type.slice(1);
                const catInfo = categories[insight.data.category] || categories['Other'];
                let dataDisplay = '';
                if (insight.data) {
                    dataDisplay = `<div class="insight-data">`;
                    if (insight.data.category) dataDisplay += `<span class="data-item">Category: ${insight.data.category}</span>`;
                    Object.entries(insight.data).forEach(([key, value]) => {
                        if (key !== 'category') {
                            if (typeof value === 'number' && (key.includes('amount') || key.includes('spending'))) {
                                dataDisplay += `<span class="data-item">${key.replace(/_/g, ' ')}: ‚Çπ${value.toFixed(2)}</span>`;
                            } else {
                                dataDisplay += `<span class="data-item">${key.replace(/_/g, ' ')}: ${value}</span>`;
                            }
                        }
                    });
                    dataDisplay += `</div>`;
                }

                return `
                    <div class="budget-item">
                        <div class="budget-header">
                            <div class="budget-info">
                                <h3><i class="fas fa-lightbulb"></i> ${insightType}</h3>
                                <small>Confidence: ${(insight.confidence * 100).toFixed(0)}%</small>
                            </div>
                        </div>
                        <p>${insight.message}</p>
                        ${dataDisplay}
                    </div>
                `;
            }).join('');
        }

        // Display comprehensive analysis
        if (analysis.success && analysis.data) {
            insightsHtml += `
                <div class="budget-item">
                    <div class="budget-header">
                        <div class="budget-info">
                            <h3><i class="fas fa-chart-line"></i> Financial Health</h3>
                            <small>Score: ${analysis.data.financial_health_score ? analysis.data.financial_health_score.toFixed(0) + '%' : 'N/A'}</small>
                        </div>
                    </div>
                    <p>${analysis.data.summary || 'No summary available.'}</p>
                    ${analysis.data.recommendations ? `
                        <div class="insight-data">
                            <h4>Recommendations:</h4>
                            ${analysis.data.recommendations.map(rec => `<span class="data-item">${rec}</span>`).join('')}
                        </div>
                    ` : ''}
                    ${analysis.data.key_metrics ? `
                        <div class="insight-data">
                            <span class="data-item">Total Expenses: ‚Çπ${analysis.data.key_metrics.total_expenses.toFixed(2)}</span>
                            ${Object.entries(analysis.data.key_metrics.budget_status).map(([cat, status]) => `
                                <span class="data-item">${cat}: ${status.status.charAt(0).toUpperCase() + status.status.slice(1)} (‚Çπ${status.spent_amount.toFixed(2)} / ‚Çπ${status.budget_amount.toFixed(2)})</span>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        } else if (analysis.error) {
            insightsHtml += `
                <div class="budget-item">
                    <div class="budget-header">
                        <h3><i class="fas fa-exclamation-triangle"></i> Financial Health</h3>
                    </div>
                    <p>Unable to generate financial analysis: ${analysis.error}</p>
                </div>
            `;
        }

        if (insightsHtml) {
            insightsContainer.innerHTML = insightsHtml;
            document.getElementById('insights-count').textContent = document.querySelectorAll('#ai-insights .budget-item').length;
        } else {
            insightsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-brain empty-icon"></i>
                    <p>No insights available</p>
                    <small>Add more expenses for deeper analysis</small>
                </div>
            `;
            document.getElementById('insights-count').textContent = 0;
        }

        showToast('Insights and analysis refreshed!');
    } catch (error) {
        console.error('Error getting insights or analysis:', error);
        showToast('Failed to refresh insights or analysis', 'error');
    } finally {
        hideLoading();
    }
}

// --- Data Management ---
function exportData() {
    const data = { expenses, budgets };
    const dataStr = JSON.stringify(data, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
    const exportFileDefaultName = `expense_data_${new Date().toISOString().split('T')[0]}.json`;

    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    showToast('Data exported successfully!');
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            if (importedData.expenses && Array.isArray(importedData.expenses)) {
                const newExpenses = importedData.expenses.filter(exp =>
                    exp.id && exp.name && typeof exp.amount === 'number' && exp.date && exp.category
                );
                const existingIds = new Set(expenses.map(exp => exp.id));
                newExpenses.forEach(exp => {
                    if (!existingIds.has(exp.id)) {
                        expenses.push(exp);
                    }
                });
                saveExpenses();
            }
            if (importedData.budgets && Array.isArray(importedData.budgets)) {
                const newBudgets = importedData.budgets.filter(budget =>
                    budget.id && budget.category && typeof budget.amount === 'number' && budget.period
                );
                const existingBudgetIds = new Set(budgets.map(budget => budget.id));
                newBudgets.forEach(budget => {
                    if (!existingBudgetIds.has(budget.id)) {
                        budgets.push(budget);
                    }
                });
                saveBudgets();
            }
            updateAll();
            showToast('Data imported successfully!');
        } catch (error) {
            console.error('Error importing data:', error);
            showToast('Failed to import data. Invalid file format.', 'error');
        }
    };
    reader.onerror = function() {
        showToast('Error reading file.', 'error');
    };
    reader.readAsText(file);
}

// --- Update Functions ---
function updateAll() {
    updateStats();
    updateExpenseList();
    updateChart();
    updateBudgetList();
    checkBudgetAlerts();
    populateMonthSelector();
}

function updateStats() {
    const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
    const currentMonthValue = document.getElementById('month-selector').value;
    const currentMonthPrefix = currentMonthValue ? currentMonthValue.substring(0, 7) : new Date().toISOString().substring(0, 7);
    const monthlyExpenses = expenses.filter(expense => expense.date.startsWith(currentMonthPrefix));
    const monthlyTotal = monthlyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
    const uniqueCategories = new Set(expenses.map(e => e.category)).size;

    document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
    document.getElementById('month-expenses').textContent = formatCurrency(monthlyTotal);
    document.getElementById('categories-count').textContent = uniqueCategories;
    document.getElementById('insights-count').textContent = document.querySelectorAll('#ai-insights .budget-item').length;
    updateAnalytics();
}

function updateAnalytics() {
    const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
    document.getElementById('analytics-total').textContent = formatCurrency(totalExpenses);

    const categoryTotals = {};
    expenses.forEach(expense => {
        categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
    });

    const sortedCategories = Object.entries(categoryTotals).sort(([,a], [,b]) => b - a);
    if (sortedCategories.length > 0) {
        const [topCategory, topAmount] = sortedCategories[0];
        document.getElementById('analytics-top-category').textContent = topCategory;
        document.getElementById('analytics-top-amount').textContent = formatCurrency(topAmount);
    } else {
        document.getElementById('analytics-top-category').textContent = 'None';
        document.getElementById('analytics-top-amount').textContent = formatCurrency(0);
    }

    const monthlyBreakdownDiv = document.getElementById('monthly-breakdown');
    const monthlyData = {};
    const endOfMonth = new Date();
    const startOfPeriod = new Date();
    startOfPeriod.setMonth(endOfMonth.getMonth() - 5);
    startOfPeriod.setDate(1);

    const dateFormatter = new Intl.DateTimeFormat('en-US', { month: 'short', year: 'numeric' });
    expenses.forEach(expense => {
        const expenseDate = new Date(expense.date);
        if (expenseDate >= startOfPeriod && expenseDate <= endOfMonth) {
            const monthYear = expense.date.substring(0, 7);
            if (!monthlyData[monthYear]) {
                monthlyData[monthYear] = { total: 0, count: 0, displayDate: dateFormatter.format(expenseDate) };
            }
            monthlyData[monthYear].total += expense.amount;
            monthlyData[monthYear].count++;
        }
    });

    const sortedMonths = Object.keys(monthlyData).sort((a, b) => b.localeCompare(a));
    if (sortedMonths.length > 0) {
        monthlyBreakdownDiv.innerHTML = `
            <h3 style="color: var(--text-secondary); margin-bottom: 1rem;">Monthly Spending Overview</h3>
            ${sortedMonths.map(monthYear => {
                const data = monthlyData[monthYear];
                return `
                    <div class="budget-item">
                        <div class="budget-header">
                            <div class="budget-info"><h3>${data.displayDate}</h3></div>
                            <div class="budget-stats">
                                <div class="budget-amount">${formatCurrency(data.total)}</div>
                                <small>${data.count} expenses</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        `;
    } else {
        monthlyBreakdownDiv.innerHTML = '';
    }
}

function populateMonthSelector() {
    const selector = document.getElementById('month-selector');
    const usedMonths = [...new Set(expenses.map(expense => expense.date.substring(0, 7)))];
    const currentMonthYear = new Date().toISOString().substring(0, 7);

    if (!usedMonths.includes(currentMonthYear)) {
        usedMonths.push(currentMonthYear);
    }

    usedMonths.sort((a, b) => b.localeCompare(a));
    const monthOptions = usedMonths.map(month => {
        const dateForDisplay = new Date(month + '-02');
        const monthName = dateForDisplay.toLocaleString('en-US', { month: 'long', year: 'numeric' });
        return `<option value="${month}">${monthName}</option>`;
    }).join('');
    selector.innerHTML = monthOptions;

    if (usedMonths.includes(currentMonthYear)) {
        selector.value = currentMonthYear;
    } else if (usedMonths.length > 0) {
        selector.value = usedMonths[0];
    }
}

function populateBudgetCategories() {
    const selector = document.getElementById('budget-category');
    const usedCategoriesInBudgets = new Set(budgets.map(b => b.category));
    const categoryOptions = Object.entries(categories).map(([category, { icon }]) => {
        const isDisabled = usedCategoriesInBudgets.has(category) ? 'disabled' : '';
        const className = `category-option ${categories[category].class}`;
        return `<option value="${category}" ${isDisabled} class="${className}">${category}</option>`;
    }).join('');
    selector.innerHTML = `<option value="">Select Category</option>${categoryOptions}`;
}

function updateExpenseList() {
    const selectedMonth = document.getElementById('month-selector').value;
    const currentMonthPrefix = selectedMonth ? selectedMonth.substring(0, 7) : new Date().toISOString().substring(0, 7);
    const filteredExpenses = expenses.filter(expense => expense.date.startsWith(currentMonthPrefix));
    const sortedExpenses = filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
    const container = document.getElementById('expense-list-container');

    if (sortedExpenses.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-receipt empty-icon"></i>
                <p>No expenses for ${selectedMonth ? new Date(selectedMonth + '-02').toLocaleString('en-US', { month: 'long', year: 'numeric' }) : 'this month'}</p>
                <small>Click "Add Expense" to get started</small>
            </div>
        `;
        return;
    }

    container.innerHTML = sortedExpenses.map(expense => {
        const categoryInfo = categories[expense.category] || categories['Other'];
        const categoryIcon = categoryInfo.icon;
        const categoryClass = categoryInfo.class;
        return `
            <div class="expense-item">
                <div class="expense-icon ${categoryClass}">${categoryIcon}</div>
                <div class="expense-details">
                    <div class="expense-name">${expense.name}</div>
                    <div class="expense-meta">
                        <span class="${categoryClass}"><i class="fas fa-tag"></i> ${expense.category}</span>
                        <span><i class="fas fa-calendar-alt"></i> ${new Date(expense.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}</span>
                    </div>
                </div>
                <div class="expense-amount">${formatCurrency(expense.amount)}</div>
                <button class="delete-expense" onclick="deleteExpense('${expense.id}')" aria-label="Delete expense">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        `;
    }).join('');
}

function updateChart() {
    const selectedMonth = document.getElementById('month-selector').value;
    const currentMonthPrefix = selectedMonth ? selectedMonth.substring(0, 7) : new Date().toISOString().substring(0, 7);
    const filteredExpenses = expenses.filter(expense => expense.date.startsWith(currentMonthPrefix));
    const categoryData = {};
    filteredExpenses.forEach(expense => {
        categoryData[expense.category] = (categoryData[expense.category] || 0) + expense.amount;
    });

    const chartCanvas = document.getElementById('expense-chart');
    const chartEmpty = document.getElementById('chart-empty');
    const categorySummary = document.getElementById('category-summary');

    if (Object.keys(categoryData).length === 0) {
        chartCanvas.style.display = 'none';
        chartEmpty.style.display = 'flex';
        categorySummary.innerHTML = '';
        if (chart) chart.destroy();
        return;
    }

    chartCanvas.style.display = 'block';
    chartEmpty.style.display = 'none';

    const ctx = chartCanvas.getContext('2d');
    if (chart) chart.destroy();

    const availableColors = [
        '#3B82F6', '#8B5CF6', '#10B981', '#F59E0B', '#EF4444',
        '#EC4899', '#06B6D4', '#F97316', '#84CC16', '#22C55E',
        '#6366F1', '#6B7280'
    ];
    const labels = Object.keys(categoryData);
    const datasets = [{
        data: Object.values(categoryData),
        backgroundColor: labels.map((label, index) => categories[label] ? availableColors[index % availableColors.length] : availableColors[index % availableColors.length]),
        borderColor: 'var(--bg-secondary)',
        borderWidth: 3,
        hoverBorderWidth: 3
    }];

    chart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.7)',
                    titleColor: 'var(--text-primary)',
                    bodyColor: 'var(--text-primary)',
                    borderColor: 'var(--border)',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((sum, value) => sum + value, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${formatCurrency(context.parsed)} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '70%',
            hoverOffset: 15
        }
    });

    const totalSpending = Object.values(categoryData).reduce((sum, value) => sum + value, 0);
    categorySummary.innerHTML = Object.entries(categoryData)
        .sort(([,a], [,b]) => b - a)
        .map(([category, amount]) => {
            const percentage = ((amount / totalSpending) * 100).toFixed(1);
            const categoryInfo = categories[category] || categories['Other'];
            const catIcon = categoryInfo.icon;
            const catClass = categoryInfo.class;
            return `
                <div class="budget-item">
                    <div class="budget-header">
                        <div class="budget-info">
                            <span class="${catClass}">${catIcon}</span> <h3>${category}</h3>
                        </div>
                        <div class="budget-stats">
                            <div class="budget-amount">${formatCurrency(amount)}</div>
                            <small>${percentage}%</small>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
}

function updateBudgetList() {
    const container = document.getElementById('budget-list');
    if (budgets.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-chart-bar empty-icon"></i>
                <p>No budgets set</p>
                <small>Create budgets to track your spending</small>
            </div>
        `;
        return;
    }

    budgets.sort((a, b) => a.category.localeCompare(b.category));
    container.innerHTML = budgets.map(budget => {
        const spent = getCurrentMonthExpenses(budget.category);
        const remaining = budget.amount - spent;
        let percentage = budget.amount > 0 ? Math.min((spent / budget.amount) * 100, 100) : 0;
        let status = 'good';
        if (percentage >= 100) status = 'danger';
        else if (percentage >= 80) status = 'warning';

        const categoryInfo = categories[budget.category] || categories['Other'];
        const catIcon = categoryInfo.icon;
        const catClass = categoryInfo.class;

        return `
            <div class="budget-item">
                <button class="delete-budget" onclick="deleteBudget('${budget.id}')" aria-label="Delete budget">
                    <i class="fas fa-times"></i>
                </button>
                <div class="budget-header">
                    <div class="budget-info">
                        <span class="${catClass}">${catIcon}</span>
                        <h3>${budget.category}</h3>
                    </div>
                    <div class="budget-stats">
                        <div class="budget-amount">${formatCurrency(budget.amount)}</div>
                        <small>${budget.period.charAt(0).toUpperCase() + budget.period.slice(1)}</small>
                    </div>
                </div>
                <div class="budget-progress">
                    <div class="progress-bar">
                        <div class="progress-fill ${status}" style="width: ${percentage}%;"></div>
                    </div>
                </div>
                <div class="budget-progress-header">
                    <span>Spent: ${formatCurrency(spent)}</span>
                    <span>Remaining: ${formatCurrency(remaining)}</span>
                </div>
            </div>
        `;
    }).join('');
}

function getCurrentMonthExpenses(category) {
    const currentMonthPrefix = new Date().toISOString().substring(0, 7);
    return expenses
        .filter(expense => expense.date.startsWith(currentMonthPrefix) && expense.category === category)
        .reduce((sum, expense) => sum + expense.amount, 0);
}

function checkBudgetAlerts() {
    const alertsContainer = document.getElementById('budget-alerts');
    const alertsContent = document.getElementById('alerts-container');
    let alertsHtml = '';

    budgets.forEach(budget => {
        const spent = getCurrentMonthExpenses(budget.category);
        let percentage = budget.amount > 0 ? (spent / budget.amount) * 100 : 0;
        if (percentage >= 80) {
            const alertType = percentage >= 100 ? 'danger' : 'warning';
            const catInfo = categories[budget.category] || categories['Other'];
            const icon = catInfo.icon;
            const catClass = catInfo.class;

            alertsHtml += `
                <div class="budget-item">
                    <div class="budget-header">
                        <div class="budget-info">
                            <span class="${catClass}">${icon}</span> <h3>${budget.category}</h3>
                        </div>
                        <div class="budget-stats">
                            <div class="budget-amount">${formatCurrency(spent)} / ${formatCurrency(budget.amount)}</div>
                        </div>
                    </div>
                    <div class="budget-progress">
                        <div class="progress-bar" style="height: 6px;">
                            <div class="progress-fill ${alertType}" style="width: ${Math.min(percentage, 100)}%;"></div>
                        </div>
                    </div>
                    <p class="budget-remaining ${alertType}" style="font-size: 0.85rem;">
                        ${alertType === 'danger' ? 'Over budget!' : `Nearing limit (${percentage.toFixed(0)}%)`}
                    </p>
                </div>
            `;
        }
    });

    if (alertsHtml) {
        alertsContent.innerHTML = alertsHtml;
        alertsContainer.classList.remove('hidden');
    } else {
        alertsContainer.innerHTML = '';
        alertsContainer.classList.add('hidden');
    }
}

// --- Helper Functions ---
function formatCurrency(amount) {
    return `‚Çπ${amount.toFixed(2)}`;
}
    </script>
</body>
</html>
