<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Expense Tracker</title>
    <meta name="description" content="Expense tracking with predictive analytics and insights">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’°</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #1a1a1b;
            --bg-tertiary: #2a2a2b;
            --bg-glass: rgba(26, 26, 27, 0.8);
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --accent-blue: #4a9eff;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-orange: #f59e0b;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 12px 40px rgba(0, 0, 0, 0.4);
            --gradient-primary: linear-gradient(135deg, #4a9eff 0%, #8b5cf6 100%);
            --gradient-card: linear-gradient(135deg, rgba(74, 158, 255, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 400px;
            min-height: 100vh;
            margin: 0 auto;
            background: var(--bg-primary);
            position: relative;
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
        }

        .main-content {
            padding: 20px;
            padding-bottom: 120px;
        }

        .greeting-section {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--gradient-card);
            border-radius: 20px;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .greeting-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .greeting-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .greeting-emoji {
            font-size: 24px;
        }

        .greeting-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .greeting-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .settings-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .balance-card {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }

        .balance-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .balance-icon {
            color: var(--accent-blue);
            font-size: 20px;
        }

        .balance-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .balance-amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .balance-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .action-btn {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--text-primary);
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .action-btn i {
            font-size: 20px;
            color: var(--accent-blue);
        }

        .action-btn span {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .action-btn.primary {
            background: var(--gradient-primary);
            color: white;
        }

        .action-btn.primary i,
        .action-btn.primary span {
            color: white;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--accent-blue);
            font-size: 20px;
        }

        .expense-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .expense-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .expense-item:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
        }

        .expense-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--accent-blue);
            border: 1px solid var(--border);
        }

        .expense-details {
            flex: 1;
        }

        .expense-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .expense-meta {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            gap: 15px;
        }

        .expense-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .expense-amount.negative {
            color: var(--accent-red);
        }

        .expense-amount.positive {
            color: var(--accent-green);
        }

        .delete-btn {
            background: var(--accent-red);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #c53030;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .stat-icon.income { color: var(--accent-green); }
        .stat-icon.expense { color: var(--accent-red); }
        .stat-icon.savings { color: var(--accent-blue); }
        .stat-icon.budget { color: var(--accent-purple); }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 380px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 12px;
            display: flex;
            justify-content: space-around;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow);
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 12px;
            border-radius: 15px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 60px;
        }

        .nav-btn.active {
            background: var(--gradient-primary);
            color: white;
        }

        .nav-btn i {
            font-size: 18px;
        }

        .nav-btn span {
            font-size: 10px;
            font-weight: 500;
        }

        .tab-page {
            display: none;
        }

        .tab-page.active {
            display: block;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-hover);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.2);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-muted);
        }

        .form-group input[type="date"] {
            color: var(--text-primary);
        }

        .form-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .empty-subtext {
            font-size: 14px;
            color: var(--text-muted);
        }

        .budget-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .budget-progress {
            margin-bottom: 16px;
        }

        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .budget-info h4 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        .budget-info p {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .budget-amount {
            text-align: right;
        }

        .budget-spent {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .budget-total {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--accent-orange), #ff8c42);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #ff4757, #ff6b7a);
        }

        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            margin-bottom: 25px;
            max-height: 300px;
            overflow: hidden;
        }

        .calendar-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-nav {
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            justify-content: center;
            margin: 0 auto;
            width: 100%;
        }

        .calendar-day {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .calendar-date {
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 45px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .calendar-date:hover {
            background: var(--bg-tertiary);
        }

        .calendar-date.active {
            background: var(--gradient-primary);
            color: white;
        }

        .calendar-date.active .calendar-expenses {
            color: white;
        }

        .calendar-date.has-transactions {
            border: 2px solid var(--accent-blue);
        }

        .calendar-expenses {
            font-size: 10px;
            margin-top: 3px;
            line-height: 1.2;
            font-weight: 600;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-expenses.income {
            color: var(--accent-green);
        }

        .calendar-expenses.expense {
            color: var(--accent-red);
        }

        .insights-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }

        .insights-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .insights-section-header h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insights-section-header i {
            font-size: 20px;
        }

        .refresh-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: var(--accent-blue);
            color: var(--text-primary);
        }

        .refresh-btn:focus {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        .health-score-card {
            background: var(--gradient-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            position: relative;
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .score-circle {
            width: 80px;
            height: 80px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .score-circle svg {
            position: absolute;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .score-circle .circle-bg,
        .score-circle .circle-progress {
            cx: 50%;
            cy: 50%;
            r: 45%;
        }

        .score-circle .circle-bg {
            fill: none;
            stroke: var(--bg-tertiary);
            stroke-width: 8;
        }

        .score-circle .circle-progress {
            fill: none;
            stroke: url(#score-gradient);
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }

        .score-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            z-index: 1;
        }

        .score-info h5 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .score-info p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .health-factors {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .health-factor {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .prediction-card {
            background: var(--gradient-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .prediction-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .prediction-header i {
            color: var(--accent-purple);
            font-size: 18px;
        }

        .prediction-header h5 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .prediction-content {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .prediction-content strong {
            color: var(--text-primary);
        }

        .insights-container {
            max-height: 80vh;
            overflow-y: auto;
            scroll-behavior: smooth;
            padding-right: 10px;
        }

        .insight-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .insight-card h5 {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 8px;
        }

        .insight-card p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .empty-insights {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-muted);
        }

        .empty-insights i {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .loading-spinner {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
        }

        .loading-spinner i {
            font-size: 24px;
            margin-bottom: 10px;
        }

        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
                border-left: none;
                border-right: none;
            }

            .main-content {
                padding: 15px;
                padding-bottom: 100px;
            }

            .balance-amount {
                font-size: 28px;
            }

            .bottom-nav {
                width: 95%;
                bottom: 15px;
            }

            .calendar-date {
                padding: 8px;
                min-height: 45px;
            }

            .calendar-expenses {
                font-size: 9px;
            }

            .score-circle {
                width: 60px;
                height: 60px;
            }

            .score-value {
                font-size: 18px;
            }

            .chart-container {
                max-height: 250px;
            }

            .chart-container canvas {
                max-height: 200px;
            }

            .insights-container {
                max-height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <main class="main-content">
            <!-- Home Tab -->
            <div id="tab-home" class="tab-page active">
                <div class="greeting-section">
                    <div class="greeting-header">
                        <div class="greeting-text">
                            <span class="greeting-emoji">ðŸ‘‹</span>
                            <div>
                                <div class="greeting-title" id="greeting-title">Good morning!</div>
                                <div class="greeting-subtitle">Here's your spending</div>
                            </div>
                        </div>
                        <button class="settings-btn" onclick="openModal('settings-modal')">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>

                <div class="balance-card">
                    <div class="balance-header">
                        <i class="fas fa-wallet balance-icon"></i>
                        <span class="balance-label">Current Balance</span>
                    </div>
                    <div class="balance-amount" id="balance-amount">â‚¹0.00</div>
                    <div class="balance-subtitle">**** 1910</div>
                </div>

                <div class="quick-actions">
                    <button class="action-btn" onclick="openModal('income-modal')">
                        <i class="fas fa-plus"></i>
                        <span>Add Income</span>
                    </button>
                    <button class="action-btn primary" onclick="openModal('expense-modal')">
                        <i class="fas fa-minus"></i>
                        <span>Add Expense</span>
                    </button>
                    <button class="action-btn" onclick="switchTab('history')">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Transfer</span>
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon income">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div class="stat-value" id="total-income">â‚¹0.00</div>
                        <div class="stat-label">Income</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon expense">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div class="stat-value" id="total-expense">â‚¹0.00</div>
                        <div class="stat-label">Expenses</div>
                    </div>
                </div>

                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-history"></i>
                        Recent Transactions
                    </h3>
                </div>
                <div class="expense-list" id="recent-expenses"></div>

                <div class="chart-container">
                    <canvas id="expense-chart" aria-label="Pie chart of expense categories"></canvas>
                </div>
            </div>

            <!-- Insights Tab -->
            <div id="tab-ai" class="tab-page">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Financial Insights
                    </h3>
                </div>
                <div class="insights-container">
                    <div class="insights-section">
                        <div class="insights-section-header">
                            <h4 id="health-score-title"><i class="fas fa-heartbeat"></i> Financial Health Score</h4>
                            <button class="refresh-btn" onclick="updateInsights()" aria-label="Refresh financial health score">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div id="health-score-card" class="health-score-card" role="region" aria-labelledby="health-score-title">
                            <div class="score-display">
                                <div class="score-circle" role="img" aria-label="Financial health score progress">
                                    <svg>
                                        <defs>
                                            <linearGradient id="score-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                                <stop offset="0%" style="stop-color:#4a9eff" />
                                                <stop offset="100%" style="stop-color:#8b5cf6" />
                                            </linearGradient>
                                        </defs>
                                        <circle class="circle-bg" cx="50%" cy="50%" r="45%" />
                                        <circle class="circle-progress" cx="50%" cy="50%" r="45%" stroke-dasharray="213.628" stroke-dashoffset="213.628" />
                                    </svg>
                                    <span class="score-value" id="health-score">--</span>
                                </div>
                                <div class="score-info">
                                    <h5 id="health-grade">--</h5>
                                    <p id="health-message">Click refresh to analyze</p>
                                </div>
                            </div>
                            <div id="health-factors" class="health-factors" aria-label="Factors affecting financial health"></div>
                        </div>
                    </div>

                    <div class="insights-section">
                        <div class="insights-section-header">
                            <h4><i class="fas fa-crystal-ball"></i> Month-End Prediction</h4>
                        </div>
                        <div id="prediction-card" class="prediction-card">
                            <div class="prediction-header">
                                <i class="fas fa-chart-line"></i>
                                <h5>Projected Expenses</h5>
                            </div>
                            <div id="prediction-content" class="prediction-content">
                                <p>Click refresh to get predictions</p>
                            </div>
                        </div>
                    </div>

                    <div class="insights-section">
                        <div class="insights-section-header">
                            <h4><i class="fas fa-chart-bar"></i> Spending Trends</h4>
                        </div>
                        <div class="chart-container">
                            <canvas id="category-trend-chart" aria-label="Bar chart of spending by category"></canvas>
                        </div>
                    </div>

                    <div class="insights-section">
                        <div class="insights-section-header">
                            <h4><i class="fas fa-chart-line"></i> Daily Spending Pattern</h4>
                        </div>
                        <div class="chart-container">
                            <canvas id="daily-spending-chart" aria-label="Line chart of daily spending patterns"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Tab -->
            <div id="tab-budget" class="tab-page">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-chart-pie"></i>
                        Budget Overview
                    </h3>
                </div>
                <div class="budget-section">
                    <div id="budget-list"></div>
                    <button class="btn btn-primary" onclick="openModal('budget-modal')">
                        <i class="fas fa-plus"></i>
                        Add Budget
                    </button>
                </div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="tab-page">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-history"></i>
                        Transaction History
                    </h3>
                </div>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        <span id="calendar-month-year"></span>
                        <button class="calendar-nav" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid" id="calendar-days"></div>
                </div>
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-list"></i>
                        Transactions
                    </h3>
                </div>
                <div class="expense-list" id="all-expenses"></div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-btn active" onclick="switchTab('home')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-btn" onclick="switchTab('ai')">
                <i class="fas fa-chart-line"></i>
                <span>Insights</span>
            </button>
            <button class="nav-btn" onclick="switchTab('budget')">
                <i class="fas fa-chart-pie"></i>
                <span>Budget</span>
            </button>
            <button class="nav-btn" onclick="switchTab('history')">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
        </nav>
    </div>

    <div id="expense-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Expense</h2>
                <button class="close-btn" onclick="closeModal('expense-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="expense-form">
                    <div class="form-group">
                        <label for="expense-name">Expense Name</label>
                        <input type="text" id="expense-name" placeholder="e.g., Lunch at Cafe" required>
                    </div>
                    <div class="form-group">
                        <label for="expense-amount">Amount (â‚¹)</label>
                        <input type="number" id="expense-amount" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="expense-category">Category</label>
                        <select id="expense-category">
                            <option value="">Select Category (Auto-detected)</option>
                            <option value="food">Food & Dining</option>
                            <option value="transportation">Transportation</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="bills">Bills & Utilities</option>
                            <option value="shopping">Shopping</option>
                            <option value="health">Health & Fitness</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expense-date">Date</label>
                        <input type="date" id="expense-date" required>
                    </div>
                    <div class="form-group">
                        <label for="expense-description">Description (Optional)</label>
                        <textarea id="expense-description" rows="3" placeholder="Add a note..."></textarea>
                    </div>
                    <div class="form-buttons">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('expense-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Add Expense
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="income-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Income</h2>
                <button class="close-btn" onclick="closeModal('income-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="income-form">
                    <div class="form-group">
                        <label for="income-name">Income Source</label>
                        <input type="text" id="income-name" placeholder="e.g., Salary, Freelance" required>
                    </div>
                    <div class="form-group">
                        <label for="income-amount">Amount (â‚¹)</label>
                        <input type="number" id="income-amount" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="income-category">Category</label>
                        <select id="income-category" required>
                            <option value="">Select Category</option>
                            <option value="salary">Salary</option>
                            <option value="freelance">Freelance</option>
                            <option value="investment">Investment</option>
                            <option value="gift">Gift</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="income-date">Date</label>
                        <input type="date" id="income-date" required>
                    </div>
                    <div class="form-buttons">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('income-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Add Income
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="close-btn" onclick="closeModal('settings-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="user-name">Your Name</label>
                    <input type="text" id="user-name" placeholder="Enter your name">
                    <button class="btn btn-primary" style="margin-top: 12px;" onclick="saveUserName()">Save Name</button>
                </div>
                <div class="form-group">
                    <label>Data Management</label>
                    <div class="form-buttons">
                        <button class="btn btn-primary" onclick="exportData()">Export Data</button>
                        <input type="file" id="import-data" accept=".json" style="display: none;" onchange="importData(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('import-data').click()">Import Data</button>
                    </div>
                </div>
                <div class="form-group">
                    <button class="btn btn-danger" onclick="resetData()">Reset All Data</button>
                </div>
            </div>
        </div>
    </div>

    <div id="budget-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Budget</h2>
                <button class="close-btn" onclick="closeModal('budget-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="budget-form">
                    <div class="form-group">
                        <label for="budget-category">Category</label>
                        <select id="budget-category" required>
                            <option value="">Select Category</option>
                            <option value="food">Food & Dining</option>
                            <option value="transportation">Transportation</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="bills">Bills & Utilities</option>
                            <option value="shopping">Shopping</option>
                            <option value="health">Health & Fitness</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="budget-amount">Budget Amount (â‚¹)</label>
                        <input type="number" id="budget-amount" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-buttons">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('budget-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Add Budget
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let balance = 0;
        let totalIncome = 0;
        let totalExpenses = 0;
        let transactions = [];
        let budgets = {};
        let userName = '';
        let expenseChart = null;
        let categoryTrendChart = null;
        let dailySpendingChart = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let previousMonthData = null;

        const categoryIcons = {
            food: 'fas fa-utensils',
            transportation: 'fas fa-car',
            entertainment: 'fas fa-gamepad',
            bills: 'fas fa-file-invoice',
            shopping: 'fas fa-shopping-cart',
            health: 'fas fa-heartbeat',
            other: 'fas fa-question',
            salary: 'fas fa-wallet',
            freelance: 'fas fa-laptop',
            investment: 'fas fa-chart-line',
            gift: 'fas fa-gift'
        };

        function saveToLocalStorage() {
            const data = {
                balance,
                totalIncome,
                totalExpenses,
                transactions,
                budgets,
                userName,
                previousMonthData,
                currentMonth,
                currentYear
            };
            localStorage.setItem('expenseTrackerData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const data = localStorage.getItem('expenseTrackerData');
            if (data) {
                const parsed = JSON.parse(data);
                balance = parsed.balance || 0;
                totalIncome = parsed.totalIncome || 0;
                totalExpenses = parsed.totalExpenses || 0;
                transactions = parsed.transactions || [];
                budgets = parsed.budgets || {};
                userName = parsed.userName || '';
                previousMonthData = parsed.previousMonthData || null;
                currentMonth = parsed.currentMonth ?? new Date().getMonth();
                currentYear = parsed.currentYear ?? new Date().getFullYear();
            }
        }

        function getIconForCategory(category) {
            return categoryIcons[category] || 'fas fa-question';
        }

        function getISTDate() {
            return new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));
        }

        function formatDate(date) {
            const today = getISTDate();
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            }
            return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function getGreeting() {
            const hour = getISTDate().getHours();
            let greeting;
            if (hour < 12) greeting = 'Good morning';
            else if (hour < 18) greeting = 'Good afternoon';
            else greeting = 'Good evening';
            return userName ? `${greeting}, ${userName}!` : `${greeting}!`;
        }

        function checkAndResetData() {
            const today = getISTDate();
            const currentDay = today.getDate();
            const newMonth = today.getMonth();
            const newYear = today.getFullYear();

            if (newMonth !== currentMonth || newYear !== currentYear) {
                previousMonthData = {
                    balance,
                    totalIncome,
                    totalExpenses,
                    transactions,
                    budgets,
                    userName,
                    month: currentMonth,
                    year: currentYear
                };
                balance = 0;
                totalIncome = 0;
                totalExpenses = 0;
                transactions = [];
                budgets = {};
                currentMonth = newMonth;
                currentYear = newYear;
                saveToLocalStorage();
                updateUI();
            }

            if (newMonth === 6 && newYear === 2025 && currentDay > 10 && previousMonthData && previousMonthData.month === 5 && previousMonthData.year === 2025) {
                previousMonthData = null;
                saveToLocalStorage();
            }
        }

        function exportData() {
            const today = getISTDate();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            if (previousMonthData && previousMonthData.month === 5 && previousMonthData.year === 2025 && currentMonth === 6 && currentYear === 2025 && currentDay <= 10) {
                const data = previousMonthData;
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `expense_tracker_june_2025_${getISTDate().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                alert('June 2025 data exported successfully.');
            } else if (currentMonth === previousMonthData?.month && currentYear === previousMonthData?.year) {
                const data = {
                    balance,
                    totalIncome,
                    totalExpenses,
                    transactions,
                    budgets,
                    userName,
                    month: currentMonth,
                    year: currentYear
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `expense_tracker_${getISTDate().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                alert('Current month data exported successfully.');
            } else {
                alert('No data available to export for the requested period.');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    balance = data.balance || 0;
                    totalIncome = data.totalIncome || 0;
                    totalExpenses = data.totalExpenses || 0;
                    transactions = data.transactions || [];
                    budgets = data.budgets || {};
                    userName = data.userName || '';
                    currentMonth = data.month ?? getISTDate().getMonth();
                    currentYear = data.year ?? getISTDate().getFullYear();
                    saveToLocalStorage();
                    updateUI();
                    alert('Data imported successfully.');
                } catch (err) {
                    alert('Invalid file format. Please upload a valid JSON file.');
                }
            };
            reader.readAsText(file);
        }

        function renderTransactionList(containerId, transactionsToRender, showDeleteButton = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (transactionsToRender.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="empty-icon"><i class="fas fa-list"></i></div>
                    <div class="empty-text">No Transactions</div>
                    <div class="empty-subtext">Add a transaction to get started</div>
                `;
                container.appendChild(emptyState);
                return;
            }
            transactionsToRender.forEach(transaction => {
                const expenseItem = document.createElement('div');
                expenseItem.className = 'expense-item';
                const amountClass = transaction.amount < 0 ? 'negative' : 'positive';
                expenseItem.innerHTML = `
                    <div class="expense-icon">
                        <i class="${transaction.icon}"></i>
                    </div>
                    <div class="expense-details">
                        <div class="expense-name">${transaction.name}</div>
                        <div class="expense-meta">
                            <span>${transaction.category}</span>
                            <span>${transaction.date}</span>
                        </div>
                    </div>
                    <div class="expense-amount ${amountClass}">${transaction.amount < 0 ? '-' : '+'}â‚¹${Math.abs(transaction.amount).toFixed(2)}</div>
                    ${showDeleteButton ? `<button class="delete-btn" onclick="deleteTransaction(${transaction.id})"><i class="fas fa-trash"></i></button>` : ''}
                `;
                container.appendChild(expenseItem);
            });
        }

        async function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                const transaction = transactions.find(t => t.id === id);
                if (transaction) {
                    try {
                        const response = await fetch(`/api/expenses/${id}`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();
                        if (result.success) {
                            balance -= transaction.amount;
                            if (transaction.amount > 0) {
                                totalIncome -= transaction.amount;
                            } else {
                                totalExpenses -= Math.abs(transaction.amount);
                            }
                            transactions = transactions.filter(t => t.id !== id);
                            saveToLocalStorage();
                            updateUI();
                        } else {
                            alert('Failed to delete transaction: ' + result.error);
                        }
                    } catch (error) {
                        console.error('Error deleting transaction:', error);
                        alert('Error deleting transaction');
                    }
                }
            }
        }

        function updateBalanceUI() {
            document.getElementById('balance-amount').textContent = `â‚¹${balance.toFixed(2)}`;
        }

        function updateStatsUI() {
            document.getElementById('total-income').textContent = `â‚¹${totalIncome.toFixed(2)}`;
            document.getElementById('total-expense').textContent = `â‚¹${totalExpenses.toFixed(2)}`;
        }

        function calculateCategoryExpenses(category) {
            return transactions
                .filter(t => {
                    const transactionDate = new Date(t.date === 'Today' ? getISTDate() : t.date);
                    return transactionDate.getMonth() === currentMonth &&
                           transactionDate.getFullYear() === currentYear &&
                           t.amount < 0 &&
                           t.category === category;
                })
                .reduce((total, t) => total + Math.abs(t.amount), 0);
        }

        function renderBudgetList() {
            const budgetList = document.getElementById('budget-list');
            budgetList.innerHTML = '';
            if (Object.keys(budgets).length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="empty-icon"><i class="fas fa-chart-pie"></i></div>
                    <div class="empty-text">No Budgets</div>
                    <div class="empty-subtext">Add a budget to start tracking</div>
                `;
                budgetList.appendChild(emptyState);
                return;
            }
            Object.keys(budgets).forEach(category => {
                const spent = calculateCategoryExpenses(category);
                const total = budgets[category];
                const percentage = total > 0 ? (spent / total) * 100 : 0;
                const progressClass = percentage > 90 ? 'danger' : percentage > 75 ? 'warning' : '';
                const budgetCard = document.createElement('div');
                budgetCard.className = 'budget-progress';
                budgetCard.innerHTML = `
                    <div class="budget-header">
                        <div class="budget-info">
                            <h4>${category.charAt(0).toUpperCase() + category.slice(1)}</h4>
                            <p>Monthly budget</p>
                        </div>
                        <div class="budget-amount">
                            <div class="budget-spent">â‚¹${spent.toFixed(2)}</div>
                            <div class="budget-total">of â‚¹${total.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${progressClass}" style="width: ${Math.min(percentage, 100)}%"></div>
                    </div>
                `;
                budgetList.appendChild(budgetCard);
            });
        }

        async function addBudget(category, amount) {
            try {
                const response = await fetch('/api/budgets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        category: category,
                        amount: amount,
                        period: 'monthly'
                    })
                });
                const result = await response.json();
                if (result.success) {
                    budgets[category] = amount;
                    saveToLocalStorage();
                    renderBudgetList();
                } else {
                    alert('Failed to add budget: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding budget:', error);
                alert('Error adding budget');
            }
        }

        function renderExpenseChart() {
            const monthlyTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date === 'Today' ? getISTDate() : t.date);
                return transactionDate.getMonth() === currentMonth &&
                       transactionDate.getFullYear() === currentYear &&
                       t.amount < 0;
            });

            const categoryTotals = monthlyTransactions.reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + Math.abs(t.amount);
                return acc;
            }, {});

            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);

            const ctx = document.getElementById('expense-chart').getContext('2d');

            if (expenseChart) {
                expenseChart.destroy();
            }

            if (labels.length === 0) {
                ctx.canvas.parentElement.innerHTML = `
                    <div class="empty-insights">
                        <i class="fas fa-chart-pie"></i>
                        <p>No spending data for this month.</p>
                    </div>
                `;
                return;
            }

            expenseChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'var(--accent-red)',
                            'var(--accent-blue)',
                            'var(--accent-orange)',
                            'var(--accent-green)',
                            'var(--accent-purple)',
                            'var(--accent-orange)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'var(--text-primary)',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'var(--bg-glass)',
                            titleColor: 'var(--text-primary)',
                            bodyColor: 'var(--text-secondary)',
                            borderColor: 'var(--border)',
                            borderWidth: 1,
                            cornerRadius: 10,
                            padding: 10
                        }
                    }
                }
            });
        }

        function renderCategoryTrendChart() {
            const monthlyTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date === 'Today' ? getISTDate() : t.date);
                return transactionDate.getMonth() === currentMonth &&
                       transactionDate.getFullYear() === currentYear &&
                       t.amount < 0;
            });

            const categoryTotals = monthlyTransactions.reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + Math.abs(t.amount);
                return acc;
            }, {});

            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);

            const ctx = document.getElementById('category-trend-chart').getContext('2d');

            if (categoryTrendChart) {
                categoryTrendChart.destroy();
            }

            if (labels.length === 0) {
                ctx.canvas.parentElement.innerHTML = `
                    <div class="empty-insights">
                        <i class="fas fa-chart-bar"></i>
                        <p>No spending data for this month.</p>
                    </div>
                `;
                return;
            }

            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, 'var(--accent-blue)');
            gradient.addColorStop(1, 'var(--accent-purple)');

            categoryTrendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Spending by Category',
                        data: data,
                        backgroundColor: gradient,
                        borderColor: 'var(--accent-blue)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (â‚¹)',
                                color: 'var(--text-primary)',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                }
                            },
                            ticks: {
                                color: 'var(--text-secondary)',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'var(--border)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Category',
                                color: 'var(--text-primary)',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                }
                            },
                            ticks: {
                                color: 'var(--text-secondary)',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'var(--bg-glass)',
                            titleColor: 'var(--text-primary)',
                            bodyColor: 'var(--text-secondary)',
                            borderColor: 'var(--border)',
                            borderWidth: 1,
                            cornerRadius: 10,
                            padding: 10
                        }
                    }
                }
            });
        }

        function renderDailySpendingChart() {
            const monthlyTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date === 'Today' ? getISTDate() : t.date);
                return transactionDate.getMonth() === currentMonth &&
                       transactionDate.getFullYear() === currentYear &&
                       t.amount < 0;
            });

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const dailyTotals = Array(daysInMonth).fill(0);

            monthlyTransactions.forEach(t => {
                const day = new Date(t.date === 'Today' ? getISTDate() : t.date).getDate() - 1;
                dailyTotals[day] += Math.abs(t.amount);
            });

            const labels = Array.from({ length: daysInMonth }, (_, i) => (i + 1).toString());

            const ctx = document.getElementById('daily-spending-chart').getContext('2d');

            if (dailySpendingChart) {
                dailySpendingChart.destroy();
            }

            if (dailyTotals.every(total => total === 0)) {
                ctx.canvas.parentElement.innerHTML = `
                    <div class="empty-insights">
                        <i class="fas fa-chart-line"></i>
                        <p>No spending data for this month.</p>
                    </div>
                `;
                return;
            }

            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, 'var(--accent-blue)');
            gradient.addColorStop(1, 'var(--accent-purple)');

            dailySpendingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Spending',
                        data: dailyTotals,
                        fill: true,
                        backgroundColor: gradient,
                        borderColor: 'var(--accent-blue)',
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (â‚¹)',
                                color: 'var(--text-primary)',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                }
                            },
                            ticks: {
                                color: 'var(--text-secondary)',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'var(--border)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Day of Month',
                                color: 'var(--text-primary)',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                }
                            },
                            ticks: {
                                color: 'var(--text-secondary)',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'var(--bg-glass)',
                            titleColor: 'var(--text-primary)',
                            bodyColor: 'var(--text-secondary)',
                            borderColor: 'var(--border)',
                            borderWidth: 1,
                            cornerRadius: 10,
                            padding: 10
                        }
                    }
                }
            });
        }

        function calculateFinancialHealth() {
            const monthlyIncome = transactions
                .filter(t => {
                    const transactionDate = new Date(t.date === 'Today' ? getISTDate() : t.date);
                    return transactionDate.getMonth() === currentMonth &&
                           transactionDate.getFullYear() === currentYear &&
                           t.amount > 0;
                })
                .reduce((total, t) => total + t.amount, 0);

            const monthlyExpenses = transactions
                .filter(t => {
                    const transactionDate = new Date(t.date === 'Today' ? getISTDate() : t.date);
                    return transactionDate.getMonth() === currentMonth &&
                           transactionDate.getFullYear() === currentYear &&
                           t.amount < 0;
                })
                .reduce((total, t) => total + Math.abs(t.amount), 0);

            const savingsRate = monthlyIncome > 0 ? ((monthlyIncome - monthlyExpenses) / monthlyIncome) * 100 : 0;
            const budgetAdherence = Object.keys(budgets).reduce((total, category) => {
                const spent = calculateCategoryExpenses(category);
                const budget = budgets[category];
                return total + (budget > 0 ? Math.min(100, (budget - spent) / budget * 100) : 100);
            }, 0) / Math.max(Object.keys(budgets).length, 1);

            const categoryCount = new Set(transactions
                .filter(t => {
                    const transactionDate = new Date(t.date === 'Today' ? getISTDate() : t.date);
                    return transactionDate.getMonth() === currentMonth &&
                           transactionDate.getFullYear() === currentYear &&
                           t.amount < 0;
                })
                .map(t => t.category)).size;

            let score = 0;
            score += Math.min(savingsRate, 100) * 0.4;
            score += budgetAdherence * 0.4;
            score += Math.min(categoryCount * 10, 20);

            score = Math.min(Math.max(Math.round(score), 0), 100);

            const factors = [];
            if (savingsRate < 10) factors.push('Low savings rate');
            if (budgetAdherence < 80) factors.push('Budget overruns');
            if (categoryCount > 5) factors.push('Diverse spending');
            if (monthlyExpenses > monthlyIncome) factors.push('Overspending');

            let grade, message;
            if (score >= 80) {
                grade = 'Excellent';
                message = 'Your finances are in great shape!';
            } else if (score >= 60) {
                grade = 'Good';
                message = 'Solid financial health, with room for improvement.';
            } else if (score >= 40) {
                grade = 'Fair';
                message = 'Consider adjusting your spending habits.';
            } else {
                grade = 'Poor';
                message = 'Significant improvements needed in financial management.';
            }

            return { score, grade, message, factors };
        }

        function calculateMonthEndPrediction() {
            const today = getISTDate();
            const currentDay = today.getDate();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysRemaining = daysInMonth - currentDay;

            const monthlyExpenses = transactions
                .filter(t => {
                    const transactionDate = new Date(t.date === 'Today' ? getISTDate() : t.date);
                    return transactionDate.getMonth() === currentMonth &&
                           transactionDate.getFullYear() === currentYear &&
                           t.amount < 0;
                })
                .reduce((total, t) => total + Math.abs(t.amount), 0);

            const dailyAverage = currentDay > 0 ? monthlyExpenses / currentDay : 0;
            const predictedTotal = monthlyExpenses + (dailyAverage * daysRemaining);

            return {
                current: monthlyExpenses.toFixed(2),
                predicted: predictedTotal.toFixed(2),
                daysRemaining
            };
        }

        function updateHealthScoreUI(health) {
            const scoreElement = document.getElementById('health-score');
            const gradeElement = document.getElementById('health-grade');
            const messageElement = document.getElementById('health-message');
            const factorsElement = document.getElementById('health-factors');
            const circleProgress = document.querySelector('.circle-progress');

            scoreElement.textContent = health.score;
            gradeElement.textContent = health.grade;
            messageElement.textContent = health.message;

            factorsElement.innerHTML = '';
            health.factors.forEach(factor => {
                const factorElement = document.createElement('span');
                factorElement.className = 'health-factor';
                factorElement.textContent = factor;
                factorsElement.appendChild(factorElement);
            });

            const circle = document.querySelector('.score-circle');
            const radius = circle.clientWidth * 0.45;
            const circumference = 2 * Math.PI * radius;
            circleProgress.setAttribute('stroke-dasharray', circumference);
            const offset = circumference - (health.score / 100) * circumference;
            circleProgress.style.strokeDashoffset = offset;
        }

        function updatePredictionUI(prediction) {
            const predictionContent = document.getElementById('prediction-content');
            predictionContent.innerHTML = `
                <p>Current spending: <strong>â‚¹${prediction.current}</strong></p>
                <p>Projected month-end total: <strong>â‚¹${prediction.predicted}</strong></p>
                <p>Days remaining: <strong>${prediction.daysRemaining}</strong></p>
            `;
        }

        async function updateInsights() {
            const spinner = document.createElement('div');
            spinner.className = 'loading-spinner';
            spinner.innerHTML = '<i class="fas fa-spinner fa-spin"></i><p>Loading insights...</p>';
            document.getElementById('tab-ai').prepend(spinner);

            if (transactions.length === 0) {
                document.querySelectorAll('#tab-ai .insights-section').forEach(section => {
                    section.innerHTML = `
                        <div class="empty-insights">
                            <i class="fas fa-info-circle"></i>
                            <p>No data available to generate insights.</p>
                            <p>Add transactions to see financial insights.</p>
                        </div>
                    `;
                });
                spinner.remove();
                return;
            }

            const health = calculateFinancialHealth();
            updateHealthScoreUI(health);
            const prediction = calculateMonthEndPrediction();
            updatePredictionUI(prediction);
            renderCategoryTrendChart();
            renderDailySpendingChart();
            spinner.remove();
        }

        function renderCalendar() {
            const calendarDays = document.getElementById('calendar-days');
            const monthYear = document.getElementById('calendar-month-year');
            calendarDays.innerHTML = '';

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            monthYear.textContent = `${monthNames[currentMonth]} ${currentYear}`;

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                calendarDays.appendChild(dayElement);
            });

            const transactionsByDate = transactions.reduce((acc, t) => {
                const date = t.date === 'Today' ? getISTDate().toISOString().split('T')[0] : t.date;
                if (!acc[date]) acc[date] = { total: 0, count: 0 };
                acc[date].total += t.amount;
                acc[date].count += 1;
                return acc;
            }, {});

            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-date';
                calendarDays.appendChild(emptyDay);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = date.toISOString().split('T')[0];
                const dateElement = document.createElement('div');
                dateElement.className = 'calendar-date';
                if (transactionsByDate[dateStr]) {
                    dateElement.className += ' has-transactions';
                }
                if (selectedDate && selectedDate.toISOString().split('T')[0] === dateStr) {
                    dateElement.className += ' active';
                }
                dateElement.innerHTML = `
                    <span>${day}</span>
                    ${transactionsByDate[dateStr] ? `
                        <span class="calendar-expenses ${transactionsByDate[dateStr].total < 0 ? 'expense' : 'income'}">
                            ${transactionsByDate[dateStr].count} items
                        </span>
                    ` : ''}
                `;
                dateElement.onclick = () => {
                    selectedDate = date;
                    updateUI();
                };
                calendarDays.appendChild(dateElement);
            }
        }

        function changeMonth(offset) {
            currentMonth += offset;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear -= 1;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear += 1;
            }
            selectedDate = null;
            saveToLocalStorage();
            updateUI();
        }
        
        function updateUI() {
            document.getElementById('greeting-title').textContent = getGreeting();
            updateBalanceUI();
            updateStatsUI();
            renderBudgetList();
            renderTransactionList('recent-expenses', transactions.slice(-5).reverse());
            if (document.getElementById('tab-history').classList.contains('active')) {
                renderCalendar();
                const transactionsToShow = selectedDate
                    ? transactions.filter(t => {
                        const transactionDate = t.date === 'Today' ? getISTDate() : new Date(t.date);
                        return transactionDate.toISOString().split('T')[0] === selectedDate.toISOString().split('T')[0];
                    })
                    : transactions;
                renderTransactionList('all-expenses', transactionsToShow, true);
            }
            if (document.getElementById('tab-home').classList.contains('active')) {
                renderExpenseChart();
            }
            if (document.getElementById('tab-ai').classList.contains('active')) {
                updateInsights();
            }
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            if (modalId === 'expense-modal') {
                const expenseDate = document.getElementById('expense-date');
                expenseDate.value = getISTDate().toISOString().split('T')[0];
            } else if (modalId === 'income-modal') {
                const incomeDate = document.getElementById('income-date');
                incomeDate.value = getISTDate().toISOString().split('T')[0];
            } else if (modalId === 'settings-modal') {
                document.getElementById('user-name').value = userName;
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'expense-modal') {
                document.getElementById('expense-form').reset();
                document.getElementById('expense-date').value = getISTDate().toISOString().split('T')[0];
            } else if (modalId === 'income-modal') {
                document.getElementById('income-form').reset();
                document.getElementById('income-date').value = getISTDate().toISOString().split('T')[0];
            } else if (modalId === 'budget-modal') {
                document.getElementById('budget-form').reset();
            }
        }
        
        function saveUserName() {
            userName = document.getElementById('user-name').value.trim();
            if (userName) {
                saveToLocalStorage();
                updateUI();
                closeModal('settings-modal');
                alert('Name saved successfully!');
            } else {
                alert('Please enter a valid name.');
            }
        }
        
        function resetData() {
            if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
                balance = 0;
                totalIncome = 0;
                totalExpenses = 0;
                transactions = [];
                budgets = {};
                userName = '';
                previousMonthData = null;
                currentMonth = getISTDate().getMonth();
                currentYear = getISTDate().getFullYear();
                saveToLocalStorage();
                updateUI();
                alert('All data has been reset.');
            }
        }
        
        async function addExpense(name, amount, category, date, description) {
            const lowerName = name.toLowerCase();
            const autoCategory = category || (
                lowerName.includes('food') || lowerName.includes('lunch') || lowerName.includes('dinner') ? 'food' :
                lowerName.includes('transport') || lowerName.includes('uber') || lowerName.includes('bus') ? 'transportation' :
                lowerName.includes('movie') || lowerName.includes('game') ? 'entertainment' :
                lowerName.includes('bill') || lowerName.includes('utility') ? 'bills' :
                lowerName.includes('shop') || lowerName.includes('clothes') ? 'shopping' :
                lowerName.includes('health') || lowerName.includes('gym') ? 'health' : 'other'
            );
        
            try {
                const response = await fetch('/api/expenses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name,
                        amount: -Math.abs(amount),
                        category: autoCategory,
                        date,
                        description
                    })
                });
                const result = await response.json();
                if (result.success) {
                    const transaction = {
                        id: result.data.id,
                        name,
                        amount: -Math.abs(amount),
                        category: autoCategory,
                        date: formatDate(new Date(date)),
                        description,
                        icon: getIconForCategory(autoCategory)
                    };
                    transactions.push(transaction);
                    balance -= Math.abs(amount);
                    totalExpenses += Math.abs(amount);
                    saveToLocalStorage();
                    updateUI();
                    closeModal('expense-modal');
                } else {
                    alert('Failed to add expense: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding expense:', error);
                alert('Error adding expense');
            }
        }
        
        async function addIncome(name, amount, category, date) {
            try {
                const response = await fetch('/api/incomes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name,
                        amount: Math.abs(amount),
                        category,
                        date
                    })
                });
                const result = await response.json();
                if (result.success) {
                    const transaction = {
                        id: result.data.id,
                        name,
                        amount: Math.abs(amount),
                        category,
                        date: formatDate(new Date(date)),
                        icon: getIconForCategory(category)
                    };
                    transactions.push(transaction);
                    balance += Math.abs(amount);
                    totalIncome += Math.abs(amount);
                    saveToLocalStorage();
                    updateUI();
                    closeModal('income-modal');
                } else {
                    alert('Failed to add income: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding income:', error);
                alert('Error adding income');
            }
        }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-page').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.querySelector(`.nav-btn[onclick="switchTab('${tabId}')"]`).classList.add('active');
            if (tabId === 'history') {
                renderCalendar();
                const transactionsToShow = selectedDate
                    ? transactions.filter(t => {
                        const transactionDate = t.date === 'Today' ? getISTDate() : new Date(t.date);
                        return transactionDate.toISOString().split('T')[0] === selectedDate.toISOString().split('T')[0];
                    })
                    : transactions;
                renderTransactionList('all-expenses', transactionsToShow, true);
            } else if (tabId === 'ai') {
                updateInsights();
            } else if (tabId === 'home') {
                renderExpenseChart();
            }
            updateUI();
        }
        
        // Event Listeners
        document.getElementById('expense-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('expense-name').value.trim();
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const date = document.getElementById('expense-date').value;
            const description = document.getElementById('expense-description').value.trim();
            if (name && amount > 0 && date) {
                addExpense(name, amount, category, date, description);
            } else {
                alert('Please fill in all required fields with valid values.');
            }
        });
        
        document.getElementById('income-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('income-name').value.trim();
            const amount = parseFloat(document.getElementById('income-amount').value);
            const category = document.getElementById('income-category').value;
            const date = document.getElementById('income-date').value;
            if (name && amount > 0 && category && date) {
                addIncome(name, amount, category, date);
            } else {
                alert('Please fill in all required fields with valid values.');
            }
        });
        
        document.getElementById('budget-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const category = document.getElementById('budget-category').value;
            const amount = parseFloat(document.getElementById('budget-amount').value);
            if (category && amount > 0) {
                addBudget(category, amount);
                closeModal('budget-modal');
            } else {
                alert('Please select a category and enter a valid amount.');
            }
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            checkAndResetData();
            updateUI();
        });
        </script>
        </body>
        </html>
